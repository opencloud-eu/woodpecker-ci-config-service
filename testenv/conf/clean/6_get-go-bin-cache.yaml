name: get-go-bin-cache
steps:
  - image: owncloudci/drone-skip-pipeline
    name: skip-if-unchanged
    settings:
      ALLOW_SKIP_CHANGED:
        - ^.github/.*
        - ^.vscode/.*
        - ^changelog/.*
        - ^docs/.*
        - ^deployments/.*
        - CHANGELOG.md
        - CONTRIBUTING.md
        - LICENSE
        - README.md
        - ^tests/acceptance/.*
    when:
      event:
        - pull_request
  - commands:
      - bash -x /go/src/github.com/opencloud-eu/opencloud/tests/config/drone/check_go_bin_cache.sh /go/src/github.com/opencloud-eu/opencloud go-bin.tar.gz
    environment:
      CACHE_BUCKET:
        from_secret: cache_s3_bucket
      CACHE_ENDPOINT:
        from_secret: cache_s3_server
    image: owncloud/ubuntu:20.04
    name: check-go-bin-cache
  - commands:
      - make bingo-update
    environment:
      HTTP_PROXY:
        from_secret: drone_http_proxy
      HTTPS_PROXY:
        from_secret: drone_http_proxy
    image: owncloudci/golang:1.22
    name: bingo-get
  - commands:
      - tar -czvf /go/src/github.com/opencloud-eu/opencloud/go-bin.tar.gz /go/bin
    image: owncloud/ubuntu:20.04
    name: archive-go-bin
  - commands:
      - BINGO_HASH=$(cat /go/src/github.com/opencloud-eu/opencloud/.bingo_hash)
      - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
      - mc cp -r /go/src/github.com/opencloud-eu/opencloud/go-bin.tar.gz s3/$CACHE_BUCKET/ocis/go-bin/$BINGO_HASH
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: cache_s3_access_key
      AWS_SECRET_ACCESS_KEY:
        from_secret: cache_s3_secret_key
      CACHE_BUCKET:
        from_secret: cache_s3_bucket
      MC_HOST:
        from_secret: cache_s3_server
    image: minio/mc:RELEASE.2021-10-07T04-19-58Z
    name: cache-go-bin
when:
  - branch:
      - main
      - stable-*
    event:
      - push
      - manual
  - event: pull_request
workspace:
  base: /go
  path: src/github.com/opencloud-eu/opencloud/
