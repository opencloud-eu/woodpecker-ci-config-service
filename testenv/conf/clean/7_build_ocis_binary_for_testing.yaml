name: build_ocis_binary_for_testing
steps:
  - image: owncloudci/drone-skip-pipeline
    name: skip-if-unchanged
    settings:
      ALLOW_SKIP_CHANGED:
        - ^.github/.*
        - ^.vscode/.*
        - ^changelog/.*
        - ^docs/.*
        - ^deployments/.*
        - CHANGELOG.md
        - CONTRIBUTING.md
        - LICENSE
        - README.md
        - .*_test.go$
    when:
      event:
        - pull_request
  - commands:
      - pnpm config set store-dir ./.pnpm-store
      - retry -t 3 'make ci-node-generate'
    environment:
      CHROMEDRIVER_SKIP_DOWNLOAD: "true"
    image: owncloudci/nodejs:20
    name: generate nodejs
  - commands:
      - retry -t 3 'make ci-go-generate'
    environment:
      HTTP_PROXY:
        from_secret: drone_http_proxy
      HTTPS_PROXY:
        from_secret: drone_http_proxy
    image: owncloudci/golang:1.22
    name: generate go
  - commands:
      - retry -t 3 'make -C ocis build'
    environment:
      HTTP_PROXY:
        from_secret: drone_http_proxy
      HTTPS_PROXY:
        from_secret: drone_http_proxy
    image: owncloudci/golang:1.22
    name: build
  - image: plugins/s3-cache:1
    name: rebuild_ocis-binary-amd64_build_artifact_cache
    settings:
      access_key:
        from_secret: cache_s3_access_key
      endpoint:
        from_secret: cache_s3_server
      fallback_path: cache/slug/commit-${DRONE_BUILD_NUMBER}
      filename: ocis-binary-amd64_build_artifact_cache.tar
      mount:
        - ocis/bin
      path: cache/slug/commit-${DRONE_BUILD_NUMBER}
      rebuild: true
      restore: false
      secret_key:
        from_secret: cache_s3_secret_key
when:
  - branch: main
    event:
      - push
      - manual
  - event: pull_request
workspace:
  base: /go
  path: src/github.com/opencloud-eu/opencloud/
