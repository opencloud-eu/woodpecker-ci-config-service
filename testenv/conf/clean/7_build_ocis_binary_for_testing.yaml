steps:
  - image: owncloudci/drone-skip-pipeline
    name: skip-if-unchanged
    settings:
      ALLOW_SKIP_CHANGED:
        - ^.github/.*
        - ^.vscode/.*
        - ^changelog/.*
        - ^docs/.*
        - ^deployments/.*
        - CHANGELOG.md
        - CONTRIBUTING.md
        - LICENSE
        - README.md
        - .*_test.go$
    when:
      event:
        - pull_request
  - commands:
      - pnpm config set store-dir ./.pnpm-store
      - retry -t 3 'make ci-node-generate'
    environment:
      CHROMEDRIVER_SKIP_DOWNLOAD: "true"
    image: owncloudci/nodejs:20
    name: generate nodejs
  - commands:
      - retry -t 3 'make ci-go-generate'
    environment:
      HTTP_PROXY:
        from_secret: drone_http_proxy
      HTTPS_PROXY:
        from_secret: drone_http_proxy
    image: owncloudci/golang:1.22
    name: generate go
  - commands:
      - retry -t 3 'make -C ocis build'
    environment:
      HTTP_PROXY:
        from_secret: drone_http_proxy
      HTTPS_PROXY:
        from_secret: drone_http_proxy
    image: owncloudci/golang:1.22
    name: build
  - image: woodpeckerci/plugin-s3
    name: rebuild_ocis-binary-amd64_build_artifact_cache
    settings:
      bucket:
        from_secret: cache_s3_bucket
      access_key:
        from_secret: cache_s3_access_key
      secret_key:
        from_secret: cache_s3_secret_key
      endpoint:
        from_secret: cache_s3_server
      path_style: true
      source: ocis/bin/**/*
      target: /cache/slug/commit-${CI_COMMIT_SHA}
when:
  - evaluate: 'ENV_WORKFLOW_SKIP_7_BUILD_OCIS_BINARY_FOR_TESTING != "true"' # TODO
